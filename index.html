function doGet(e) {
  var result = {};
  
  // V21: 強化偽裝，模擬真實瀏覽器行為
  var headers = {
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
    "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8",
    "Accept-Language": "zh-TW,zh;q=0.9,en-US;q=0.8,en;q=0.7",
    "Referer": "https://www.pilio.idv.tw/", // 騙網站說是從首頁點進來的
    "Cache-Control": "no-cache",
    "Pragma": "no-cache"
  };

  var params = {
    "method": "get",
    "headers": headers,
    "muteHttpExceptions": true // 遇到錯誤不報錯，而是回傳錯誤碼以便處理
  };

  function fetchHistory(url, type) {
    var history = [];
    try {
      // 加亂數防止 Google 快取舊資料
      var targetUrl = url + "?t=" + new Date().getTime(); 
      var response = UrlFetchApp.fetch(targetUrl, params);
      var code = response.getResponseCode();

      // 診斷 1: 如果網站回傳不是 200 (例如 403 被擋)，回傳錯誤資訊
      if (code !== 200) {
        return [{ date: "網站阻擋(" + code + ")", nums: [0,0,0,0,0,0], special: 0 }];
      }

      var html = response.getContentText("BIG5");
      
      // 診斷 2: 網站可能回傳空內容或驗證頁面
      if (html.length < 500) {
         return [{ date: "內容異常", nums: [0,0,0,0,0,0], special: 0 }];
      }

      // V21: 更寬容的切割方式，適應網站微調
      var rows = html.split(/<tr[^>]*>/i); 

      for (var i = 0; i < rows.length; i++) {
        var row = rows[i];
        
        // 抓日期: 支援 2025/12/12 或 12/12
        var dateMatch = row.match(/(\d{2,4}\/\d{1,2}\/\d{1,2})/);
        
        if (dateMatch) {
          // 清理 HTML 標籤
          var cleanRow = row.replace(/<[^>]*>/g, " ").replace(/&nbsp;/g, " ").replace(/\s+/g, " ");
          var nums = [], special = 0;

          // 抓取所有數字 (2位數)
          var allNums = cleanRow.match(/\d{2}/g);
          
          if (allNums && allNums.length >= 5) {
            if (type === "539") {
               // 539: 找連續的5個數字
               var m = cleanRow.match(/(\d{2}),\s*(\d{2}),\s*(\d{2}),\s*(\d{2}),\s*(\d{2})/);
               if(m) nums = [m[1], m[2], m[3], m[4], m[5]];
            } else {
               // 大樂透/威力彩
               var m = cleanRow.match(/(\d{2}),\s*(\d{2}),\s*(\d{2}),\s*(\d{2}),\s*(\d{2}),\s*(\d{2})/);
               if(m) {
                 nums = [m[1], m[2], m[3], m[4], m[5], m[6]];
                 // 嘗試更聰明地抓特別號
                 var parts = cleanRow.split(/特別號|第二區/);
                 if(parts.length > 1) {
                    var spMatch = parts[1].match(/\d{2}/);
                    if(spMatch) special = parseInt(spMatch[0]);
                 } else {
                    // 沒抓到關鍵字，直接取最後一個數字
                    if(allNums.length > 6) special = parseInt(allNums[allNums.length-1]);
                 }
               }
            }

            if (nums.length > 0) {
              // 補完年份 (若只有 12/12 補成 2025/12/12)
              var dateStr = dateMatch[1];
              if(dateStr.length <= 5) {
                 var yearMatch = row.match(/(\d{2,3})\(/); // 找 25(五) 或 114(五)
                 var yearPrefix = "2025"; 
                 if(yearMatch) {
                    var y = yearMatch[1];
                    if(y.length === 2) yearPrefix = "20" + y;
                    if(y.length === 3) yearPrefix = (parseInt(y) + 1911).toString();
                 }
                 dateStr = yearPrefix + "/" + dateStr;
              }

              history.push({
                date: dateStr,
                nums: nums.map(Number),
                special: (type === "539") ? null : special
              });
            }
          }
        }
        if (history.length >= 20) break;
      }
    } catch (e) {
      return [{ date: "程式錯誤", nums: [], special: 0, error: e.toString() }];
    }
    
    if(history.length === 0) return [{ date: "無資料", nums: [0,0,0,0,0,0], special: 0 }];
    return history;
  }

  result["big"] = fetchHistory("https://www.pilio.idv.tw/ltobig/list.asp", "big");
  result["power"] = fetchHistory("https://www.pilio.idv.tw/lto/list.asp", "power");
  result["539"] = fetchHistory("https://www.pilio.idv.tw/lto539/list.asp", "539");

  return ContentService.createTextOutput(JSON.stringify(result))
    .setMimeType(ContentService.MimeType.JSON);
}

// ★★★ 除錯專用函式 ★★★
// 如果 App 還是讀取失敗，請在編輯器上方選擇「debugLottery」並按下「執行」
// 查看下方的「執行記錄」，告訴我它顯示了什麼錯誤
function debugLottery() {
  var url = "https://www.pilio.idv.tw/ltobig/list.asp";
  var params = {
    "method": "get",
    "headers": { 
      "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
      "Referer": "https://www.pilio.idv.tw/"
    },
    "muteHttpExceptions": true
  };
  try {
    var response = UrlFetchApp.fetch(url, params);
    console.log("狀態碼: " + response.getResponseCode()); // 應該是 200
    console.log("內容長度: " + response.getContentText("BIG5").length);
  } catch(e) {
    console.log("連線失敗: " + e.toString());
  }
}
