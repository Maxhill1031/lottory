function doGet(e) {
  var result = {};

  // ★ 核心偽裝技術：完整的瀏覽器標頭 ★
  // 這會讓伺服器以為請求來自一台真實的電腦，而不是 Google 的伺服器
  var headers = {
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
    "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7",
    "Accept-Language": "zh-TW,zh;q=0.9,en-US;q=0.8,en;q=0.7",
    "Accept-Encoding": "gzip, deflate, br",
    "Connection": "keep-alive",
    "Upgrade-Insecure-Requests": "1",
    "Sec-Fetch-Dest": "document",
    "Sec-Fetch-Mode": "navigate",
    "Sec-Fetch-Site": "none",
    "Sec-Fetch-User": "?1",
    "Cache-Control": "max-age=0"
  };

  var params = {
    "method": "get",
    "headers": headers,
    "muteHttpExceptions": true // 遇到錯誤不要直接掛掉，讓我們有機會處理
  };

  // 通用抓取函式 (使用目前最穩定的樂透雲來源)
  function fetchLotteryData(url, type) {
    var history = [];
    try {
      // 技巧：網址加上隨機亂數 (Math.random)，強制讀取最新資料，不讀快取
      var targetUrl = url + "?" + Math.floor(Math.random() * 99999);
      
      // 送出偽裝後的請求
      var response = UrlFetchApp.fetch(targetUrl, params);
      
      // 檢查對方是否給了 200 OK
      if (response.getResponseCode() !== 200) {
        return [{ date: "來源忙碌中", nums: [0,0,0,0,0,0], special: 0 }];
      }

      var html = response.getContentText("UTF-8");
      
      // 開始解析 HTML (針對樂透雲結構)
      var rows = html.split(/<tr[^>]*>/i);

      for (var i = 0; i < rows.length; i++) {
        var row = rows[i];
        
        // 抓日期 (格式 YYYY/MM/DD)
        var dateMatch = row.match(/(\d{4}\/\d{1,2}\/\d{1,2})/);
        
        if (dateMatch) {
          var dateStr = dateMatch[1];
          // 清理雜訊，只留數字
          var cleanRow = row.replace(/<[^>]*>/g, ",").replace(/\s+/g, ""); 
          // 截取日期之後的內容來找號碼
          var rowBody = cleanRow.split(dateStr)[1] || "";
          var numsAll = rowBody.match(/\d{2}/g);

          if (numsAll && numsAll.length >= 5) {
            var nums = [];
            var special = 0;

            if (type === "539") {
              if(numsAll.length >= 5) nums = numsAll.slice(0, 5).map(Number).sort(function(a,b){return a-b});
            } else if (type === "power") {
              if(numsAll.length >= 7) {
                nums = numsAll.slice(0, 6).map(Number).sort(function(a,b){return a-b});
                special = parseInt(numsAll[6]);
              }
            } else { // 大樂透
              if(numsAll.length >= 7) {
                nums = numsAll.slice(0, 6).map(Number).sort(function(a,b){return a-b});
                special = parseInt(numsAll[6]);
              }
            }

            if (nums.length > 0) {
              history.push({
                date: dateStr,
                nums: nums,
                special: (type === "539") ? null : special
              });
            }
          }
        }
        if (history.length >= 25) break; // 抓最近 25 期
      }
    } catch (e) {
      return [{ date: "讀取錯誤", nums: [], special: 0, error: e.toString() }];
    }

    if(history.length === 0) return [{ date: "查無資料", nums: [0,0,0,0,0,0], special: 0 }];
    return history;
  }

  // 設定來源 (樂透雲目前最穩定，且配合上述 Header 可完美偽裝)
  // 為每個請求加上特定的 Referer，增加真實度
  headers["Referer"] = "https://lotto.arclink.com.tw/";
  
  result["big"] = fetchLotteryData("https://lotto.arclink.com.tw/Lotto649.html", "big");
  result["power"] = fetchLotteryData("https://lotto.arclink.com.tw/SuperLotto638.html", "power");
  result["539"] = fetchLotteryData("https://lotto.arclink.com.tw/Lotto539.html", "539");

  return ContentService.createTextOutput(JSON.stringify(result))
    .setMimeType(ContentService.MimeType.JSON);
}
