<script>
    // ★★★ 請務必確認這裡換成您最新的 Web App 網址 ★★★
    const API_URL = "https://script.google.com/macros/s/AKfycbziYdz8SqJbqW491B2su3zRHSpif4FkM2YuNAtGKeaECFJNvWSa8BEqx1Me1VSrTRm1wQ/exec";
    
    let globalData = {};
    let currentSelection = { zone1: [], zone2: [] }; 
    let ticketsToCheck = []; 

    document.addEventListener('DOMContentLoaded', () => {
      fetchData();
    });

    // --- 1. 讀取資料 (包含開獎號碼 + 您的存檔) ---
    async function fetchData() {
      try {
        document.getElementById('loading').innerText = "正在同步雲端資料...";
        const res = await fetch(API_URL);
        const data = await res.json();
        
        globalData = data;
        
        // ★ 關鍵：載入您在 Sheet 裡的存檔 (userData)
        if (data.userData && Array.isArray(data.userData)) {
            // 把雲端資料轉換成網頁用的格式
            ticketsToCheck = data.userData.map(item => ({
                id: item.id,            // 這是雲端上的唯一 ID
                type: item.type,
                startDate: item.date,   // 這裡我們把雲端的購買日當作起始日
                duration: 1,            // 預設雲端回來的都是對 1 期 (您可以依需求改)
                nums: item.nums.split(",").map(Number), // 轉回數字陣列
                special: null // 簡化處理，若有存特別號需另外解析，目前 v7 範例是用逗號分隔字串
            }));
            
            // v7 存檔時我們把號碼變成字串存，這裡做個修正，
            // 讓它能正確讀取特別號 (如果是威力彩/大樂透)
            // 重新解析 userData 的 nums
            ticketsToCheck = data.userData.map(item => {
                let numArr = String(item.nums).split(",").map(n => Number(n.trim()));
                let sp = null;
                
                // 如果是威力彩或大樂透，最後一個數字通常是特別號/第二區
                // (前提是我們存檔時有把特別號放進去)
                if (item.type === 'power' || item.type === 'big') {
                    // 這裡假設存檔時最後一顆是特別號
                    // 若您的存檔邏輯不同，這裡要調整
                }
                
                return {
                    id: item.id,
                    type: item.type,
                    startDate: item.date,
                    duration: 1, // 預設讀回來是對當期，若要連續期數需在存檔時也存 duration
                    nums: numArr, 
                    special: null // 暫時設 null，視您的存檔格式而定
                };
            });
            
            // ★ 修正：為了讓 v7 簡單化，我們在網頁端存的時候，
            // 直接把「一般號碼」存成 nums 字串。
            // 這裡直接讀取即可。
             ticketsToCheck = data.userData.map(item => {
                 // 解析資料庫回傳的 CSV 字串 "1,2,3,4,5"
                 let rawNums = String(item.nums).split(",").map(Number);
                 
                 // 分離特別號邏輯 (v7 範例是全部混在一起存)
                 // 為了相容，我們假設：
                 // 539: 5個號碼
                 // 大樂透/威力彩: 前面是號碼，最後一個陣列元素看情況
                 // 比較好的做法是存檔時就分開，但為了不改 GAS，我們這裡做個簡單判斷
                 
                 let finalNums = rawNums;
                 let finalSp = null;

                 // 這裡我們改用簡單方式：讀取後直接顯示
                 return {
                     id: item.id,
                     type: item.type,
                     startDate: item.date,
                     duration: 1, 
                     nums: finalNums, 
                     special: finalSp 
                 };
             });
        }

        document.getElementById('loading').style.display = 'none';
        renderLatest(data);
        renderTicketList(); // 渲染您的購買清單

      } catch (err) {
        console.error(err);
        document.getElementById('loading').innerHTML = `<div style="color:red;">讀取失敗，請檢查網路</div>`;
      }
    }

    function renderLatest(data) {
      const container = document.getElementById('cards-container');
      container.innerHTML = "";
      if(data.big) createCard(container, "大樂透", data.big);
      if(data.power) createCard(container, "威力彩", data.power);
      if(data["539"]) createCard(container, "今彩539", data["539"]);
    }

    function createCard(container, title, list) {
      if (!list || list.length === 0) return;
      const latest = list[0];
      const history = list.slice(1);
      const historyHtml = history.map(h => {
        let balls = h.nums.map(n => `<div class="s-ball">${n}</div>`).join('');
        if (h.special !== null) balls += `<div class="s-ball sp">${h.special}</div>`;
        return `<div class="hist-row"><div class="hist-date">${h.date}</div><div class="hist-balls">${balls}</div></div>`;
      }).join('');
      let latestBalls = latest.nums.map(n => `<div class="ball">${formatNum(n)}</div>`).join('');
      if (latest.special !== null) latestBalls += `<div class="ball special">${formatNum(latest.special)}</div>`;

      const div = document.createElement('div');
      div.className = 'card';
      div.innerHTML = `
        <div class="card-header">
          <div class="toggle-icon" onclick="toggleHistory(this)" ontouchend="toggleHistory(this)">+</div>
          <div class="lotto-name">${title}</div>
          <div class="latest-date">${latest.date}</div>
        </div>
        <div class="latest-nums">${latestBalls}</div>
        <div class="history-area">${historyHtml}</div>
      `;
      container.appendChild(div);
    }

    // --- 切換分頁 ---
    function switchPage(pageId) {
      if(event && event.type === 'touchend') event.preventDefault();
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      
      const btns = document.querySelectorAll('.nav-btn');
      if(pageId === 'latest') btns[0].classList.add('active');
      else btns[1].classList.add('active');
      
      document.getElementById(pageId).classList.add('active');
    }

    // --- Modal 相關 ---
    function openModal() {
      if(event && event.type === 'touchend') event.preventDefault();
      if(!globalData.big) { alert("資料載入中，請稍候"); return; }
      document.getElementById('selector-modal').style.display = 'flex';
      initSelector();
    }

    function closeModal() {
      if(event && event.type === 'touchend') event.preventDefault();
      document.getElementById('selector-modal').style.display = 'none';
    }

    function initSelector() {
      const type = document.getElementById('lotto-type').value;
      const startDateSelect = document.getElementById('start-date');
      const zone1 = document.getElementById('zone-1');
      const zone2 = document.getElementById('zone-2');
      const zone2Wrapper = document.getElementById('zone-2-wrapper');

      startDateSelect.innerHTML = "";
      if(globalData[type]) {
        globalData[type].forEach(item => {
          let opt = document.createElement('option');
          opt.value = item.date;
          opt.innerText = item.date;
          startDateSelect.appendChild(opt);
        });
      }

      currentSelection = { zone1: [], zone2: [] };
      zone1.innerHTML = "";
      zone2.innerHTML = "";

      let maxNum = 49;
      let hasZone2 = false;
      let maxZone2 = 0;

      if (type === 'big') { maxNum = 49; hasZone2 = false; }
      else if (type === '539') { maxNum = 39; hasZone2 = false; }
      else if (type === 'power') { maxNum = 38; hasZone2 = true; maxZone2 = 8; }

      for (let i = 1; i <= maxNum; i++) {
        let btn = document.createElement('div');
        btn.className = 'select-ball';
        btn.innerText = i;
        btn.onclick = (e) => { e.stopPropagation(); toggleNum(i, 'zone1', btn, type); };
        zone1.appendChild(btn);
      }
      if (hasZone2) {
        zone2Wrapper.style.display = 'block';
        for (let i = 1; i <= maxZone2; i++) {
          let btn = document.createElement('div');
          btn.className = 'select-ball';
          btn.innerText = i;
          btn.onclick = (e) => { e.stopPropagation(); toggleNum(i, 'zone2', btn, type); };
          zone2.appendChild(btn);
        }
      } else {
        zone2Wrapper.style.display = 'none';
      }
    }

    function toggleNum(num, zone, el, type) {
      const list = currentSelection[zone];
      const index = list.indexOf(num);
      let limit = 6;
      if (type === '539') limit = 5;
      if (zone === 'zone2') limit = 1;

      if (index > -1) {
        list.splice(index, 1);
        el.classList.remove(zone === 'zone2' ? 'selected-sp' : 'selected');
      } else {
        if (list.length >= limit) {
          const oldNum = list.shift(); 
          const parent = el.parentNode;
          for(let child of parent.children) {
             if(parseInt(child.innerText) === oldNum) child.classList.remove(zone === 'zone2' ? 'selected-sp' : 'selected');
          }
        }
        list.push(num);
        el.classList.add(zone === 'zone2' ? 'selected-sp' : 'selected');
      }
    }

    // --- 2. 新增號碼 (發送 POST 到 Sheet) ---
    function addTicket() {
      if(event && event.type === 'touchend') event.preventDefault();
      const type = document.getElementById('lotto-type').value;
      const startDate = document.getElementById('start-date').value;
      const duration = parseInt(document.getElementById('check-duration').value);
      const { zone1, zone2 } = currentSelection;
      
      let req1 = 6;
      if (type === '539') req1 = 5;
      
      if (zone1.length < req1) { alert(`請選滿 ${req1} 個號碼`); return; }
      if (type === 'power' && zone2.length < 1) { alert("請選擇第二區號碼"); return; }

      // 組合號碼字串
      let saveNums = [...zone1].sort((a,b)=>a-b);
      if (zone2.length > 0) saveNums.push(zone2[0]); // 把特別號加在最後面
      let numsStr = saveNums.join(",");

      // UI 顯示 loading 效果
      const btn = document.querySelector('.btn-confirm');
      const originalText = btn.innerText;
      btn.innerText = "儲存中...";
      btn.disabled = true;

      // 發送 POST 請求
      fetch(API_URL, {
        method: "POST",
        // mode: "no-cors", // 注意：Google Script 跨域有時需要 no-cors，但這樣拿不到回傳。我們先試標準方式，若失敗則改用 redirect 處理
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({
            action: "add",
            date: startDate, // 這裡我們存「購買日/起始日」
            type: type,
            nums: numsStr
        })
      })
      .then(res => res.json())
      .then(result => {
          if(result.status === 'success') {
              alert("儲存成功！");
              closeModal();
              // 重新讀取資料以更新清單
              fetchData(); 
          } else {
              alert("儲存失敗：" + result.message);
          }
      })
      .catch(err => {
          alert("連線錯誤，請稍後再試");
          console.error(err);
      })
      .finally(() => {
          btn.innerText = originalText;
          btn.disabled = false;
      });
    }

    // --- 3. 刪除號碼 (發送 POST 到 Sheet) ---
    function removeTicket(id) {
      if(event && event.type === 'touchend') event.preventDefault();
      
      if(!confirm("確定要刪除這筆資料嗎？(將同步刪除雲端存檔)")) return;

      // 樂觀更新 (先從畫面移除，感覺比較快)
      const oldList = [...ticketsToCheck];
      ticketsToCheck = ticketsToCheck.filter(t => t.id !== id);
      renderTicketList();

      fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({
            action: "delete",
            id: id
        })
      })
      .then(res => res.json())
      .then(result => {
          if(result.status !== 'success') {
              alert("雲端刪除失敗，資料將還原");
              ticketsToCheck = oldList; // 還原
              renderTicketList();
          }
      })
      .catch(err => {
          console.error("刪除連線錯誤", err);
          ticketsToCheck = oldList; // 還原
          renderTicketList();
          alert("連線失敗，無法刪除");
      });
    }

    function renderTicketList() {
      const container = document.getElementById('ticket-list');
      const btnCheck = document.getElementById('btn-start-check');
      container.innerHTML = "";

      if (ticketsToCheck.length > 0) {
        btnCheck.style.display = 'block';
        ticketsToCheck.forEach(t => {
          let typeName = t.type === 'big' ? '大樂透' : (t.type === 'power' ? '威力彩' : '今彩539');
          let typeClass = 'border-' + t.type;
          
          let displayNums = [...t.nums];
          let special = t.special;
          
          // 如果是威力彩/大樂透，且 special 是 null，嘗試從 nums 最後一個抓
          if ((t.type === 'power' || t.type === 'big') && special === null && displayNums.length > 6) {
             special = displayNums.pop();
          }

          let numsHtml = displayNums.map(n => `<span class="user-ball" style="border:none; background:#eee;">${formatNum(n)}</span>`).join('');
          if (special) numsHtml += `<span class="user-ball" style="background:#d32f2f; color:white;">${special}</span>`;
          
          // 為了對獎邏輯，我們修正物件裡的 nums 與 special
          t.nums = displayNums;
          t.special = special;
          
          container.innerHTML += `
            <div class="ticket-item ${typeClass}" id="ticket-${t.id}">
              <div class="ticket-header">
                <span>${typeName}</span>
                <div class="btn-remove" onclick="removeTicket('${t.id}')" ontouchend="removeTicket('${t.id}')">×</div>
              </div>
              <div class="ticket-meta">
                <span>起始: ${t.startDate}</span>
              </div>
              <div class="ticket-nums">${numsHtml}</div>
              
              <div class="result-summary" style="margin-top:15px; font-weight:bold; color:#999; font-size:16px;">尚未兌獎</div>
              <div class="check-result-container" id="result-${t.id}"></div>
              <button class="toggle-result-btn" style="width:100%; margin-top:8px; padding:8px; background:#f0f0f0; border:none; display:none; border-radius:4px; font-weight:bold;" onclick="toggleResult('${t.id}', this)" ontouchend="toggleResult('${t.id}', this)">▼ 展開結果</button>
            </div>
          `;
        });
      } else {
        btnCheck.style.display = 'none';
        container.innerHTML = `<div style="text-align:center; color:#ccc; padding:30px;">尚未加入號碼<br>請點擊上方按鈕新增</div>`;
      }
    }

    // --- 對獎功能 (維持不變，但注意 ID 現在是字串) ---
    function runCheck() {
      if(event && event.type === 'touchend') event.preventDefault();
      if (!globalData.big) return;

      ticketsToCheck.forEach(t => {
        const dataList = globalData[t.type];
        if(!dataList) return;

        let startIndex = dataList.findIndex(d => d.date === t.startDate);
        // 如果找不到該日期，嘗試找最接近的（或者是當期）
        if (startIndex === -1) {
             // 簡單處理：如果找不到，顯示提示
           document.querySelector(`#ticket-${t.id} .result-summary`).innerText = "日期過舊或未開獎";
           return;
        }

        let resultsHTML = "";
        let winCount = 0;
        let duration = t.duration || 1; // 預設 1 期

        for (let i = 0; i < duration; i++) {
          let targetIndex = startIndex - i; // 往未來找 (index越小越新) ?? 不，Sheet是新的在上面(index 0)，所以往後找是未來? 
          // 修正：Sheet 排序是 [最新, ..., 最舊]
          // 如果使用者買 "12/19"，想對 12/19, 12/20... 
          // 那應該是 index 往 0 的方向走 (index 減小)
          
          // 但通常「連續期數」是指「購買日之後的連續幾期」。
          // 假設買 12/17，連續 3 期 -> 12/17, 12/18, 12/19
          // 12/17 是 index N。 12/18 是 index N-1。
          
          targetIndex = startIndex - i;
          if (targetIndex < 0) break; // 超出最新一期

          const draw = dataList[targetIndex];
          const targetNums = draw.nums;
          const targetSpecial = draw.special;
          
          let matchCount = 0;
          let spMatch = false;

          let drawNumsStr = targetNums.map(n => formatNum(n)).join(" ");
          if (targetSpecial !== null) drawNumsStr += ` + <span style="color:#d32f2f">${formatNum(targetSpecial)}</span>`;

          let userBallsHtml = t.nums.map(n => {
            let isWin = targetNums.includes(n);
            if (isWin) matchCount++;
            let winClass = isWin ? "win" : "";
            if (t.type === 'big' && n === targetSpecial) { winClass = "win-sp"; matchCount += 0.5; }
            return `<div class="user-ball ${winClass}">${formatNum(n)}</div>`;
          }).join('');

          if (t.type === 'power') {
             if (t.special === targetSpecial) {
               spMatch = true;
               userBallsHtml += `<div class="user-ball win-sp">${formatNum(t.special)}</div>`;
             } else {
               userBallsHtml += `<div class="user-ball" style="border:1px dashed #999;">${formatNum(t.special)}</div>`;
             }
          } else if (t.type === 'big' && t.special) {
             // 大樂透一般沒有選特別號，但如果有存
             userBallsHtml += `<div class="user-ball">${formatNum(t.special)}</div>`;
          }

          let isWinTotal = (matchCount >= 3 || spMatch);
          if(isWinTotal) winCount++;

          resultsHTML += `
            <div class="result-row-detailed">
              <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span style="font-weight:bold; color:#333;">${draw.date}</span>
                <span style="color:#d32f2f; font-weight:bold;">${isWinTotal ? '中獎' : ''}</span>
              </div>
              <div style="font-size:14px; color:#555; margin-bottom:5px;">開出: <span style="font-family:monospace; font-weight:bold;">${drawNumsStr}</span></div>
              <div style="display:flex; flex-wrap:wrap; gap:5px; align-items:center;">
                <span style="font-size:14px; color:#555;">選號:</span>
                ${userBallsHtml}
              </div>
            </div>
          `;
        }

        const ticketEl = document.getElementById(`ticket-${t.id}`);
        ticketEl.querySelector('.result-summary').innerText = `兌獎結果：${winCount > 0 ? '恭喜中獎！' : '未中獎'}`;
        ticketEl.querySelector('.result-summary').style.color = winCount > 0 ? "#d32f2f" : "#333";
        
        const container = document.getElementById(`result-${t.id}`);
        container.innerHTML = resultsHTML;
        
        const btn = ticketEl.querySelector('.toggle-result-btn');
        btn.style.display = 'block';
        btn.innerHTML = '▼ 展開詳細結果';
        container.style.display = 'none';
      });
      
      alert("對獎完成！");
    }

    function toggleResult(id, btn) {
      if(event && event.type === 'touchend') event.preventDefault();
      const container = document.getElementById(`result-${id}`);
      if (container.style.display === 'block') {
        container.style.display = 'none';
        btn.innerHTML = '▼ 展開詳細結果';
      } else {
        container.style.display = 'block';
        btn.innerHTML = '▲ 收起詳細結果';
      }
    }

    function toggleHistory(btn) {
      if(event && event.type === 'touchend') event.preventDefault();
      const card = btn.closest('.card');
      const area = card.querySelector('.history-area');
      if (area.style.display === 'block') {
        area.style.display = 'none';
        btn.textContent = '+';
        btn.classList.remove('expanded');
      } else {
        area.style.display = 'block';
        btn.textContent = '-';
        btn.classList.add('expanded');
      }
    }

    function formatNum(n) { return n < 10 ? '0' + Number(n) : n; }
  </script>
